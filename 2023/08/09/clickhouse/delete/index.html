<!DOCTYPE html>
<html lang="zh-cn">
  <head>
    <meta charset="utf8" />
    <meta name="viewport" content="initial-scale=1.0, width=device-width" />
    <title>
      
        clickhouse åˆ é™¤æ“ä½œ | Youth Hope Fun
      
    </title>
    <meta name="description" content="" />
    <meta name="keywords" content="big data,olap,code" />
    
      <link rel="apple-touch-icon"
            sizes="180x180"
            href="/images/apple-touch-icon.png" />
    
    
      <link rel="icon"
            type="image/png"
            sizes="32x32"
            href="/images/favicon-32x32.png" />
    
    
      <link rel="icon"
            type="image/png"
            sizes="16x16"
            href="/images/favicon-16x16.png" />
    
    
      <link rel="mask-icon"
            href="/images/logo.svg"
            color="" />
    
    
    
      
  <style>
    @font-face {
        font-family:sourceHanSerif;
        src: url(/font/regular.ttf);
        font-weight: regular;
    }
  </style>

  <style>
    @font-face {
        font-family:sourceHanSerif;
        src: url(/font/bold.ttf);
        font-weight: bold;
    }
  </style>


    
    <link rel="stylesheet"
          type="text/css"
          href='/css/layout.css' />
    
      <script>
          var _hmt = _hmt || [];
          (function() {
              var hm = document.createElement("script");
              hm.src = "https://hm.baidu.com/hm.js?eac8d81fcf4d967c1dd1edbcc2f81719";
              var s = document.getElementsByTagName("script")[0];
              s.parentNode.insertBefore(hm, s);
          })();
      </script>
    
    
  <link rel="stylesheet" type="text/css" href="/css/post.css" />
  <link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css" />

  <meta name="generator" content="Hexo 6.3.0"></head>
  <body>
    <div class="head">
      <div class="nav">
        <a href='/' class="nav-logo">
          <img alt="logo" height="60px" width="60px" src="/images/logo.svg" />
        </a>
        <input id="navBtn" type="checkbox" />
        <div class="nav-menu">
          
            
              <a class="nav-menu-item" href="/bigdata">å¤§æ•°æ®</a>
            
              <a class="nav-menu-item" href="/algorithm">ç®—æ³•</a>
            
              <a class="nav-menu-item" href="/other">å…¶ä»–</a>
            
          
        </div>
        <label class="nav-btn" for="navBtn"></label>
      </div>
    </div>
    <div class="body">
      
  <article class="post-content">
    <div class="post-inner">
      <div class="post-content__head">
        <div class="post-title">clickhouse åˆ é™¤æ“ä½œ</div>
        <div class="post-info">
          
  <a href="/tags/clickhouse/" class="post-tag">#clickhouse</a>


          <span class="post-date">2023-08-09</span>
        </div>
      </div>
      
      <div class="post-content__body">
        
          <div class="post-gallery">
            
          </div>
        
        <p>OLAP æ•°æ®åº“è®¾è®¡çš„å®—æ—¨åœ¨äºåˆ†æé€‚åˆä¸€æ¬¡æ’å…¥å¤šæ¬¡æŸ¥è¯¢çš„ä¸šåŠ¡åœºæ™¯ï¼Œå¸‚é¢ä¸Šæˆç†Ÿçš„ AP æ•°æ®åº“åœ¨æ›´æ–°å’Œåˆ é™¤æ“ä½œä¸Šæ”¯æŒçš„å‡ä¸æ˜¯å¾ˆå¥½ï¼Œå½“ç„¶ clickhouse ä¹Ÿä¸ä¾‹å¤–ã€‚ä½†æ˜¯ä¸å‹å¥½ä¸ä»£è¡¨ä¸æ”¯æŒï¼Œæœ¬æ–‡ä¸»è¦ä»‹ç»åœ¨ clickhouse ä¸­å¦‚ä½•å®ç°æ•°æ®çš„åˆ é™¤ï¼Œä»¥åŠæœ€æ–°ç‰ˆæœ¬ä¸­ clickhouse æ‰€åšçš„ä¸€äº›æŠ€æœ¯çªç ´</p>
<span id="more"></span>

<img src="https://cdn.jsdelivr.net/gh/kpretty/oss@master/2023-08-09/Click_House_Delete_Statement_6fd661d851.png" alt="Click_House_Delete_Statement_6fd661d851" style="zoom:50%;" />

<h1 id="ä¸€ã€mutation"><a href="#ä¸€ã€mutation" class="headerlink" title="ä¸€ã€mutation"></a>ä¸€ã€mutation</h1><p>åˆšæ¥è§¦ clickhouse çš„å°ä¼™ä¼´æˆ–è®¸å¯¹ mutation å°±å¾ˆç†Ÿæ‚‰äº†ï¼Œmutation æŸ¥è¯¢å¯ä»¥çœ‹æˆ alter è¯­å¥çš„å˜ç§ã€‚è™½ç„¶ mutation èƒ½å¤Ÿæœ€ç»ˆå®ç°ä¿®æ”¹å’Œåˆ é™¤çš„éœ€æ±‚ï¼Œä½†ä¸èƒ½å®Œå…¨ç”¨é€šå¸¸æ„ä¹‰çš„ delete å’Œ update æ¥ç†è§£ï¼Œæˆ‘ä»¬éœ€è¦æ¸…é†’çš„è®¤è¯†åˆ°å®ƒçš„ä¸åŒï¼š</p>
<ol>
<li>mutation æ˜¯ä¸€ä¸ªå¾ˆé‡çš„æ“ä½œï¼Œé€‚åˆæ‰¹é‡æ•°æ®æ“ä½œ</li>
<li>ä¸æ”¯æŒäº‹åŠ¡ã€ä¸€æ—¦æ“ä½œç«‹åˆ»ç”Ÿæ•ˆæ— æ³•å›æ»š</li>
<li>mutation ä¸ºå¼‚æ­¥æ“ä½œ</li>
</ol>
<h2 id="1-1-å®æ“"><a href="#1-1-å®æ“" class="headerlink" title="1.1 å®æ“"></a>1.1 å®æ“</h2><p>åˆ›å»ºä¸€å¼ è¡¨ç”¨äºæµ‹è¯• mutation æ“ä½œ</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> mutations_operate<br>(<br>    UserId     UInt64,<br>    Score      UInt64,<br>    CreateTime DateTime<br>) engine <span class="hljs-operator">=</span> MergeTree()<br>      <span class="hljs-keyword">partition</span> <span class="hljs-keyword">by</span> toYYYYMMDD(CreateTime)<br>      <span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> UserId;<br></code></pre></td></tr></table></figure>

<p>æ¥ä¸‹æ¥åˆ†åˆ«æ’å…¥ä¸¤æ‰¹ä¸åŒåˆ†åŒºçš„æ•°æ®</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> mutations_operate<br><span class="hljs-keyword">select</span> number,<br>       <span class="hljs-built_in">abs</span>(number <span class="hljs-operator">-</span> <span class="hljs-number">100</span>),<br>       <span class="hljs-string">&#x27;2023-08-08 00:00:00&#x27;</span><br><span class="hljs-keyword">from</span> system.numbers<br>limit <span class="hljs-number">1000000</span>;<br><br><span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> mutations_operate<br><span class="hljs-keyword">select</span> number,<br>       <span class="hljs-built_in">abs</span>(number <span class="hljs-operator">-</span> <span class="hljs-number">100</span>),<br>       <span class="hljs-string">&#x27;2023-08-09 00:00:00&#x27;</span><br><span class="hljs-keyword">from</span> system.numbers<br>limit <span class="hljs-number">1000000</span>;<br></code></pre></td></tr></table></figure>

<p>å°è¯•åˆ é™¤ 20230808 åˆ†åŒºä¸­ 1000-10000 ä¹‹é—´çš„æ‰€æœ‰æ•°æ®ï¼Œsql å¦‚ä¸‹</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">alter</span> <span class="hljs-keyword">table</span> mutations_operate <span class="hljs-keyword">delete</span> <span class="hljs-keyword">where</span> toYYYYMMDD(CreateTime) <span class="hljs-operator">=</span> <span class="hljs-number">20230808</span> <span class="hljs-keyword">and</span> UserId <span class="hljs-keyword">between</span> <span class="hljs-number">1000</span> <span class="hljs-keyword">and</span> <span class="hljs-number">10000</span>;<br></code></pre></td></tr></table></figure>

<p>å¯ä»¥ç»Ÿè®¡ä¸€ä¸‹è¯¥åˆ†åŒºçš„æ•°æ®æ¡æ•°æ¥ç¡®è®¤æ˜¯å¦æˆåŠŸåˆ é™¤ï¼Œä»ä½“éªŒæ¥è¯´ç›®å‰çš„æ•°æ®è§„æ¨¡æ„Ÿå—ä¸åˆ° mutation çš„â€œé‡â€ï¼Œæ„Ÿè§‰åƒæ˜¯ç¬é—´å®Œæˆçš„ã€‚</p>
<p>å½“ç„¶æˆ‘ä»¬ä¹Ÿå¯ä»¥æŸ¥çœ‹<code>system.mutations</code>è¡¨æ¥ç›‘æ§ mutation æ“ä½œçš„è¿›åº¦</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> <span class="hljs-keyword">table</span>, mutation_id, `block_numbers.number` <span class="hljs-keyword">as</span> num, is_done<br><span class="hljs-keyword">from</span> system.mutations;<br><br>Query id: <span class="hljs-number">0878</span>a0f1<span class="hljs-operator">-</span>a5ff<span class="hljs-number">-474</span>c<span class="hljs-number">-8</span>f84<span class="hljs-number">-518</span>ce5dc5e1d<br><br>â”Œâ”€<span class="hljs-keyword">table</span>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€mutation_idâ”€â”€â”€â”€â”¬â”€numâ”€â”¬â”€is_doneâ”€â”<br>â”‚ mutations_operate â”‚ mutation_3.txt â”‚ [<span class="hljs-number">3</span>] â”‚       <span class="hljs-number">1</span> â”‚<br>â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜<br><br><span class="hljs-number">1</span> <span class="hljs-type">row</span> <span class="hljs-keyword">in</span> set. Elapsed: <span class="hljs-number">0.002</span> sec.<br></code></pre></td></tr></table></figure>

<p>mutation_id æ˜¯ä¸€ä¸ªæ—¥å¿—æ–‡ä»¶ï¼Œå¯ä»¥åœ¨è¡¨å­˜å‚¨ç›®å½•ä¸­æŸ¥çœ‹ï¼Œå®Œæ•´è®°å½•äº†æœ¬æ¬¡æ“ä½œçš„è¯­å¥å’Œæ—¶é—´ï¼Œä¾‹å¦‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">format version: 1<br>create time: 2023-08-09 18:54:06<br>commands: DELETE WHERE (toYYYYMMDD(CreateTime) = 20230808) AND ((UserId &gt;= 1000) AND (UserId &lt;= 10000))<br></code></pre></td></tr></table></figure>

<p>è€Œå…¶ä¸­çš„ 3 ä»¥åŠ<code>block_numbers.number</code>æ˜¯ mutation å·ï¼Œæ¯æ‰§è¡Œä¸€æ¡ delete æˆ– update è¯­å¥éƒ½ä¼šå¯¹åº”ä¸€ä¸ªå”¯ä¸€çš„ç¼–å·</p>
<p>id_done è¡¨ç¤ºæœ¬æ¬¡ mutation æ“ä½œæ˜¯å¦æ‰§è¡Œå®Œæˆï¼Œ1 è¡¨ç¤ºå·²ç»å®Œæˆ</p>
<h2 id="1-2-åŸç†"><a href="#1-2-åŸç†" class="headerlink" title="1.2 åŸç†"></a>1.2 åŸç†</h2><p>ä¸ºäº†æ¢å¯» mutation æ“ä½œçš„åŸç†å’Œæ‰§è¡Œæµç¨‹é‡ç½®ä¸€ä¸‹è¡¨æ•°æ®ï¼ˆåˆ é™¤é‡å»ºå³å¯ï¼‰ï¼Œåœ¨æ’å…¥ä¸¤æ‰¹æ•°æ®åæŸ¥çœ‹ç£ç›˜ç›®å½•</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell">Â» du -h<br>  0B	./detached<br>7.7M	./20230809_2_2_0<br>7.7M	./20230808_1_1_0<br> 15M	.<br></code></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°ä¸¤ä¸ªåˆ†åŒºç›®å½•å‡æ˜¯ 7.7M</p>
<p>å°è¯•æ‰§è¡Œåˆ é™¤æ“ä½œåï¼Œå¯ä»¥åœ¨æ—¥å¿—ä¸­çœ‹åˆ°ä¸‹é¢çš„æŸ¥è¯¢ä¿¡æ¯</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">&lt;Debug&gt; delete_operate.mutations_operate (7f120927-b71e-4f85-a06c-21a94b7f89e3) (SelectExecutor): Key condition: unknown, (column 0 in [1000, +Inf)), (column 0 in (-Inf, 10000]), and, and<br>&lt;Debug&gt; delete_operate.mutations_operate (7f120927-b71e-4f85-a06c-21a94b7f89e3) (SelectExecutor): Key condition: unknown, (column 0 in [1000, +Inf)), (column 0 in (-Inf, 10000]), and, and<br>&lt;Debug&gt; delete_operate.mutations_operate (7f120927-b71e-4f85-a06c-21a94b7f89e3) (SelectExecutor): MinMax index condition: (toYYYYMMDD(column 0) in [20230808, 20230808]), unknown, unknown, and, and<br>&lt;Debug&gt; delete_operate.mutations_operate (7f120927-b71e-4f85-a06c-21a94b7f89e3) (SelectExecutor): MinMax index condition: (toYYYYMMDD(column 0) in [20230808, 20230808]), unknown, unknown, and, and<br>&lt;Trace&gt; delete_operate.mutations_operate (7f120927-b71e-4f85-a06c-21a94b7f89e3) (SelectExecutor): Running binary search on index range for part 20230808_1_1_0 (124 marks)<br>&lt;Trace&gt; delete_operate.mutations_operate (7f120927-b71e-4f85-a06c-21a94b7f89e3) (SelectExecutor): Found (LEFT) boundary mark: 0<br>&lt;Debug&gt; delete_operate.mutations_operate (7f120927-b71e-4f85-a06c-21a94b7f89e3) (SelectExecutor): Selected 0/1 parts by partition key, 0 parts by primary key, 0/0 marks by primary key, 0 marks to read from 0 ranges<br>&lt;Trace&gt; delete_operate.mutations_operate (7f120927-b71e-4f85-a06c-21a94b7f89e3) (SelectExecutor): Found (RIGHT) boundary mark: 2<br>&lt;Trace&gt; delete_operate.mutations_operate (7f120927-b71e-4f85-a06c-21a94b7f89e3) (SelectExecutor): Found continuous range in 13 steps<br>&lt;Debug&gt; delete_operate.mutations_operate (7f120927-b71e-4f85-a06c-21a94b7f89e3) (SelectExecutor): Selected 1/1 parts by partition key, 1 parts by primary key, 2/123 marks by primary key, 2 marks to read from 1 ranges<br>&lt;Trace&gt; delete_operate.mutations_operate (7f120927-b71e-4f85-a06c-21a94b7f89e3) (SelectExecutor): Spreading mark ranges among streams (default reading)<br>&lt;Trace&gt; MergeTreeInOrderSelectProcessor: Reading 1 ranges in order from part 20230808_1_1_0, approx. 16384 rows starting from 0<br>&lt;Trace&gt; Aggregator: Aggregation method: without_key<br>&lt;Trace&gt; AggregatingTransform: Aggregated. 0 to 1 rows (from 0.00 B) in 0.000570041 sec. (0.000 rows/sec., 0.00 B/sec.)<br>&lt;Trace&gt; Aggregator: Merging aggregated data<br>&lt;Trace&gt; MutateTask: Part 20230809_2_2_0 doesn&#x27;t change up to mutation version 3<br></code></pre></td></tr></table></figure>

<p>é¦–å…ˆï¼Œclickhouse ä¼šä½¿ç”¨æˆ‘ä»¬æ‰§è¡Œçš„åˆ é™¤è¯­å¥ä¸­é™„å¸¦çš„ where æ¡ä»¶åœ¨æ¯ä¸ªåˆ†åŒºä¸­æ‰§è¡Œ count æŸ¥è¯¢ï¼Œä¸ºäº†åˆ¤æ–­å“ªäº›åˆ†åŒºæœ‰éœ€è¦è¢«åˆ é™¤çš„æ•°æ®ï¼Œä»æ—¥å¿—å¯ä»¥çœ‹å‡º<code>Reading 1 ranges in order from part 20230808_1_1_0, approx. 16384 rows starting from 0</code>ä»¥åŠ<code>Part 20230809_2_2_0 doesn&#39;t change up to mutation version 3</code>ã€‚æ³¨æ„æ—¥å¿—ä¸­æ‰€è¯´ 20230808 çš„èŒƒå›´æ˜¯ 0ï½16384 å¹¶ä¸æ˜¯å®é™…åˆ é™¤çš„èŒƒå›´ï¼Œè€Œæ˜¯ç´¢å¼•çš„èŒƒå›´ã€‚æˆ‘ä»¬çŸ¥é“ mergeTree å¼•æ“é»˜è®¤çš„è·³æ•°ç´¢å¼•çš„é—´éš”æ˜¯ 8192 è€Œæˆ‘ä»¬åˆ é™¤çš„æ•°æ®èŒƒå›´æ˜¯ 1000-10000ï¼Œæ˜¾ç„¶ä½œä¸ºä¸€ä¸ªæ•´å‘¨æœŸè‡ªç„¶æ˜¯ 0-16384(2x8192)</p>
<p>å½“æˆ‘ä»¬å†æ¬¡æŸ¥çœ‹ç£ç›˜ç›®å½•</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">Â» du -h<br>  0B	./detached<br>7.7M	./20230809_2_2_0<br>7.7M	./20230808_1_1_0<br>  0B	./20230809_2_2_0_3<br>7.6M	./20230808_1_1_0_3<br> 23M	.<br></code></pre></td></tr></table></figure>

<p>æ€»ç›®å½•ä» 15M å˜æˆäº† 23Mï¼Œè€Œä¸¤ä¸ªåˆ†åŒºä¹Ÿéƒ½å„è‡ªç”Ÿæˆäº†ä¸€ä¸ªä»¥ mutation version ä¸ºåç¼€çš„æ–°åˆ†åŒº</p>
<p>å› æ­¤æ¥ä¸‹æ¥çš„é€»è¾‘å¦‚ä¸‹ï¼š</p>
<p>clickhouse ä¼šåˆ›å»ºä¸€ä¸ª tmp_mut_ ä¸ºå‰ç¼€ã€mutation version ä¸ºåç¼€çš„ä¸´æ—¶åˆ†åŒºç›®å½•ï¼Œä¾‹å¦‚è¿™é‡Œçš„å°±æ˜¯ tmp_mut_20230808_1_1_0_3</p>
<p>å¯¹äºéœ€è¦åˆ é™¤çš„åˆ†åŒºï¼Œä¼šåœ¨ tmp_mut ç›®å½•ä¸­ç”Ÿæˆå…¨æ–°çš„ .bin å’Œ .mrk æ–‡ä»¶</p>
<p>å¯¹äºæ— éœ€åˆ é™¤çš„åˆ†åŒºï¼Œclickhouse ä¼šåˆ›å»ºä¸€ä¸ª tmp_clone_ ä¸ºå‰ç¼€ã€mutation version ä¸ºåç¼€çš„ä¸´æ—¶åˆ†åŒºç›®å½•å¹¶å°†åŸåˆ†åŒºé‡Œé¢çš„æ•°æ®ä»¥<strong>ç¡¬é“¾æ¥</strong>çš„æ–¹å¼æ‹·è´è¿‡å»ï¼Œå¹¶ä¿®æ”¹ç›®å½•åç§°ä¸ºæ­£ç¡®çš„æ ¼å¼</p>
<p>ä¸‹é¢æ˜¯æ‰§è¡Œçš„æ—¥å¿—æƒ…å†µ</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">&lt;Debug&gt; delete_operate.mutations_operate (4351d317-2cd6-4328-85fe-49d5beeff5c3): Clone part /opt/homebrew/var/lib/clickhouse/store/435/4351d317-2cd6-4328-85fe-49d5beeff5c3/20230809_2_2_0/ to /opt/homebrew/var/lib/clickhouse/store/435/4351d317-2cd6-4328-85fe-49d5beeff5c3/tmp_clone_20230809_2_2_0_3<br>&lt;Trace&gt; delete_operate.mutations_operate (4351d317-2cd6-4328-85fe-49d5beeff5c3): Renaming temporary part tmp_clone_20230809_2_2_0_3 to 20230809_2_2_0_3 with tid (1, 1, 00000000-0000-0000-0000-000000000000).<br>&lt;Trace&gt; MergedBlockOutputStream: filled checksums 20230808_1_1_0_3 (state Temporary)<br>&lt;Trace&gt; delete_operate.mutations_operate (4351d317-2cd6-4328-85fe-49d5beeff5c3): Renaming temporary part tmp_mut_20230808_1_1_0_3 to 20230808_1_1_0_3 with tid (1, 1, 00000000-0000-0000-0000-000000000000)<br></code></pre></td></tr></table></figure>

<p>ä»ç£ç›˜ç›®å½•ä¹Ÿå¯ä»¥ä½è¯è¿™ä¸€ç‚¹ï¼Œé¦–å…ˆä¸Šé¢çš„ 20230809_2_2_0_3 å ç”¨ç©ºé—´ä¸º 0Bï¼Œå½“ç„¶è¿™æ˜¯ mac ç‹¬æœ‰çš„ç°å®æ–¹å¼ï¼Œåœ¨å…¶å®ƒ linux ç³»ç»Ÿä¸ä¸€å®šæ˜¯è¿™ä¹ˆæ˜¾ç¤ºï¼Œè¿›å…¥å„ä¸ªåˆ†åŒºæŸ¥çœ‹ä¸€ä¸‹</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs shell">wjun :: data/delete_operate/mutations_operate â€¹stableâ€º Â» ll 20230808_1_1_0_3<br>total 15632<br>-rw-r-----@ 1 wjun  admin    17863 Aug  9 19:36 CreateTime.bin<br>-rw-r-----@ 1 wjun  admin      369 Aug  9 19:36 CreateTime.cmrk2<br>-rw-r-----@ 1 wjun  admin  3968891 Aug  9 19:36 Score.bin<br>-rw-r-----@ 1 wjun  admin      409 Aug  9 19:36 Score.cmrk2<br>-rw-r-----@ 1 wjun  admin  3969011 Aug  9 19:36 UserId.bin<br>-rw-r-----@ 1 wjun  admin      409 Aug  9 19:36 UserId.cmrk2<br>-rw-r-----@ 1 wjun  admin      490 Aug  9 19:36 checksums.txt<br>-rw-r-----@ 1 wjun  admin       90 Aug  9 19:36 columns.txt<br>-rw-r-----@ 1 wjun  admin        6 Aug  9 19:36 count.txt<br>-rw-r-----@ 1 wjun  admin       10 Aug  9 19:36 default_compression_codec.txt<br>-rw-r-----@ 1 wjun  admin        1 Aug  9 19:36 metadata_version.txt<br>-rw-r-----@ 1 wjun  admin        8 Aug  9 19:36 minmax_CreateTime.idx<br>-rw-r-----@ 1 wjun  admin        4 Aug  9 19:36 partition.dat<br>-rw-r-----@ 1 wjun  admin      188 Aug  9 19:36 primary.cidx<br>wjun :: data/delete_operate/mutations_operate â€¹stableâ€º Â» ll 20230809_2_2_0_3<br>total 15768<br>-rw-r-----@ 2 wjun  admin    18042 Aug  9 19:35 CreateTime.bin<br>-rw-r-----@ 2 wjun  admin      375 Aug  9 19:35 CreateTime.cmrk2<br>-rw-r-----@ 2 wjun  admin  4004938 Aug  9 19:35 Score.bin<br>-rw-r-----@ 2 wjun  admin      415 Aug  9 19:35 Score.cmrk2<br>-rw-r-----@ 2 wjun  admin  4004915 Aug  9 19:35 UserId.bin<br>-rw-r-----@ 2 wjun  admin      415 Aug  9 19:35 UserId.cmrk2<br>-rw-r-----@ 2 wjun  admin      490 Aug  9 19:35 checksums.txt<br>-rw-r-----@ 2 wjun  admin       90 Aug  9 19:35 columns.txt<br>-rw-r-----@ 2 wjun  admin        7 Aug  9 19:35 count.txt<br>-rw-r-----@ 2 wjun  admin       10 Aug  9 19:35 default_compression_codec.txt<br>-rw-r-----@ 2 wjun  admin        8 Aug  9 19:35 minmax_CreateTime.idx<br>-rw-r-----@ 2 wjun  admin        4 Aug  9 19:35 partition.dat<br>-rw-r-----@ 2 wjun  admin      173 Aug  9 19:35 primary.cidx<br></code></pre></td></tr></table></figure>

<p>20230809_2_2_0_3 åˆ†åŒº inode è¢«è¿æ¥æ¬¡æ•°ä¸º 2 è¡¨ç¤ºå»ºç«‹äº†ç¡¬é“¾æ¥ã€‚</p>
<p>å› æ­¤ mutation çš„åˆ é™¤é€»è¾‘å¦‚ä¸‹ï¼š</p>
<ol>
<li>æ¯ä¸ªåˆ†åŒºæ‰§è¡Œé™„å¸¦åˆ é™¤æ“ä½œçš„ where æ¡ä»¶çš„ count æŸ¥è¯¢ï¼Œè·å–éœ€è¦æ‰§è¡Œåˆ é™¤æ“ä½œçš„åˆ†åŒº</li>
<li>å¯¹äºéœ€è¦æ‰§è¡Œåˆ é™¤æ“ä½œçš„åˆ†åŒºä¼šåˆ›å»ºä¸€ä¸ªä¸´æ—¶ç›®å½•å¹¶ç”Ÿæˆå…¨æ–°ï¼ˆåˆ é™¤éœ€è¦åˆ é™¤çš„è¡Œï¼‰çš„æ–‡ä»¶ï¼Œéšå rename åˆ†åŒº</li>
<li>å¯¹äºæ— éœ€æ‰§è¡Œåˆ é™¤æ“ä½œçš„åˆ†åŒºä¼šåˆ›å»ºä¸€ä¸ªä¸´æ—¶ç›®å½•å¹¶ä»¥ç¡¬é“¾æ¥çš„æ–¹å¼æ‹·è´æ–‡ä»¶ï¼Œéšå rename åˆ†åŒº</li>
<li>åŸåˆ†åŒºåœ¨<code>system.parts</code>ä¸­ä¼šè¢«ç½®ä¸º inactive çŠ¶æ€</li>
<li>åœ¨ä¸‹ä¸€æ¬¡ merge æ˜¯åˆ é™¤åŸåˆ†åŒº</li>
</ol>
<p>è€Œå¯¹äºæ›´æ–°æ“ä½œåŸºæœ¬é€»è¾‘ä¸€è‡´ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯éœ€è¦æ‰§è¡Œæ›´æ–°æ“ä½œçš„åˆ†åŒºä¼šæœ‰å¦‚ä¸‹ä¸¤ç§æƒ…å†µï¼š</p>
<ol>
<li>åˆ†åŒºç±»å‹ä¸º wideï¼šåªä¼šé‡æ–°ç”Ÿæˆå—å½±å“è¡Œçš„ bin å’Œ mrk æ–‡ä»¶ï¼Œä¸å—å½±å“çš„æ–‡ä»¶ä»¥ç¡¬é“¾æ¥çš„æ–¹å¼æ‹·è´</li>
<li>åˆ†åŒºç±»å‹ä¸º compactï¼šå› ä¸ºæ‰€æœ‰åˆ—éƒ½æ˜¯ä¸€ä¸ªæ–‡ä»¶ï¼Œå› æ­¤ä¼šé‡æ–°ç”Ÿæˆ bin å’Œ mrk æ–‡ä»¶</li>
</ol>
<p>æ›´æ–°å’Œåˆ é™¤æ“ä½œæµç¨‹ä¸ä¸€è‡´çš„åŸå› æ˜¯ï¼šåˆ é™¤å½±å“å…¨éƒ¨åˆ—è€Œæ›´æ–°åªå½±å“éƒ¨åˆ†åˆ—</p>
<blockquote>
<p>mergeTree è¡¨çš„åˆ†åŒºç±»å‹åˆ†ä¸º wide å’Œ compact ä¸¤ç§å—<code>min_bytes_for_wide_part</code>å’Œ<code>min_rows_for_wide_part</code>å‚æ•°å½±å“ã€‚wide ç±»å‹çš„åˆ†åŒºä¸€ä¸ªåˆ—ä¸€ä¸ªæ–‡ä»¶ï¼Œcompact ç±»å‹çš„åˆ†åŒºæ‰€æœ‰åˆ—å…¬ç”¨ä¸€ä¸ªæ–‡ä»¶ï¼Œå½“åˆ†åŒºæ•°æ®çš„è¡Œæ•°å’Œå­—èŠ‚è¾ƒå°æ—¶ä¸º compact ç±»å‹ï¼Œä¸ç®¡æ˜¯æŸ¥è¯¢æ‰€æœ‰å­—æ®µæˆ–æŸä¸ªå­—æ®µç›¸å¯¹è¾ƒå¿«ï¼›å½“æ•°æ®é‡å¾ˆå¤§æ—¶å°±ä¼šä»¥åˆ—å¼å­˜å‚¨æ¥è¿½æ±‚ AP æŸ¥è¯¢æ€§èƒ½</p>
</blockquote>
<h2 id="1-3-ä¸è¶³"><a href="#1-3-ä¸è¶³" class="headerlink" title="1.3 ä¸è¶³"></a>1.3 ä¸è¶³</h2><p>å½“æˆ‘ä»¬èµ°ä¸€é mutation æ—¶å‘ç°åœ¨åˆ é™¤ä»»åŠ¡å®Œæˆåè¡¨ merge å‰çš„è¿™ä¸€æ®µæ—¶é—´ç£ç›˜ç©ºé—´ä¸å‡åå¢ï¼Œè¿™ä¸ªå°±è®©ç”¨æˆ·å¾ˆéš¾æ¥å—äº†ã€‚å› æ­¤å°±å¯èƒ½ä¼šå‡ºç°å› ä¸ºç£ç›˜ç©ºé—´ä¸è¶³æƒ³è¦åˆ é™¤æ•°æ®ï¼Œç»“æœåˆ é™¤æ“ä½œå¯¼è‡´ç©ºé—´è¿›ä¸€æ­¥ä¸è¶³çš„çª˜å¢ƒã€‚åŒæ—¶ mutation ä¼šé‡å†™å—å½±å“çš„åˆ†åŒºï¼Œè¿™ä¹Ÿæ˜¯ mutation æ“ä½œé‡çš„åŸå› æ‰€åœ¨ã€‚</p>
<h1 id="äºŒã€mergeTree"><a href="#äºŒã€mergeTree" class="headerlink" title="äºŒã€mergeTree"></a>äºŒã€mergeTree</h1><p>å¯¹äº clickhouse è¿™ç±»é«˜æ€§èƒ½åˆ†æå‹æ•°æ®åº“è€Œè¨€ï¼Œä¿®æ”¹æºæ–‡ä»¶æ˜¯ä¸€ä»¶éå¸¸å¥¢ä¾ˆä¸”ä»£ä»·æ˜‚è´µçš„æ“ä½œï¼Œç›¸å¯¹äºç›´æ¥ä¿®æ”¹æºæ–‡ä»¶ï¼Œæˆ‘ä»¬å°†ä¿®æ”¹å’Œæ–°å¢æ“ä½œéƒ½è½¬æ¢ä¸ºæ–°å¢æ“ä½œï¼Œå³ä»¥å¢ä»£åˆ å°†æ˜¯ä¸€ä¸ªéå¸¸ä¸é”™çš„é€‰æ‹©ã€‚æ˜¯ä¸æ˜¯å’Œ Hbase çš„æ€è·¯ååˆ†æ¥è¿‘ã€‚åœ¨ mergeTree å®¶æ—ä¸­æœ‰ä¸€ä¸ªç‰¹æ®Šçš„è¡¨å¼•æ“å« CollapsingMergeTreeï¼Œç¿»è¯‘è¿‡æ¥å«æŠ˜å åˆå¹¶æ ‘å¼•æ“å°±æ˜¯æä¾›äº†è¿™æ ·çš„åŠŸèƒ½ã€‚å®ƒé€šè¿‡å®šä¹‰ä¸€ä¸ª sign æ ‡è®°å­—æ®µæ¥è®°å½•æ•°æ®è¡Œçš„çŠ¶æ€ã€‚å¦‚æœ sign ä¸º 1 è¡¨ç¤ºè¿™æ˜¯ä¸€è¡Œæœ‰æ•ˆçš„æ•°æ®ï¼Œå¦‚æœ sign ä¸º -1 è¡¨ç¤ºè¿™è¡Œæ•°æ®è¢«åˆ é™¤ã€‚å½“ CollapsingMergeTree åˆ†åŒºåˆå¹¶æ—¶åŒä¸€åˆ†åŒºçš„ +1ã€-1 å°†ä¼šè¢«æŠµæ¶ˆï¼ŒçŠ¹å¦‚ä¸€å¼ çº¸æŠ˜å ä¸€èˆ¬ã€‚</p>
<h2 id="2-1-å®æ“"><a href="#2-1-å®æ“" class="headerlink" title="2.1 å®æ“"></a>2.1 å®æ“</h2><p>åˆ›å»º CollapsingMergeTree è¡¨</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> collapsing_table<br>(<br>    Id         String,<br>    Code       Int32,<br>    CreateTime DateTime,<br>    Sign       Int8<br>) engine <span class="hljs-operator">=</span> CollapsingMergeTree(Sign)<br>      <span class="hljs-keyword">partition</span> <span class="hljs-keyword">by</span> toYYYYMMDD(CreateTime)<br>      <span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> Id;<br></code></pre></td></tr></table></figure>

<blockquote>
<p>æ³¨ï¼šå’Œå…¶å®ƒ mergeTree å¼•æ“ä¸€æ · CollapsingMergeTree ä¾ç„¶æ˜¯ä»¥ order by å­—æ®µä½œä¸ºåç»­æ•°æ®å”¯ä¸€æ€§çš„ä¾æ®</p>
</blockquote>
<p>æ’å…¥ä¸€æ‰¹åŸå§‹æ•°æ®</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> collapsing_table <span class="hljs-keyword">values</span> (<span class="hljs-string">&#x27;A000&#x27;</span>, <span class="hljs-number">100</span>, <span class="hljs-string">&#x27;2023-08-09 00:00:00&#x27;</span>, <span class="hljs-number">1</span>);<br><span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> collapsing_table <span class="hljs-keyword">values</span> (<span class="hljs-string">&#x27;A001&#x27;</span>, <span class="hljs-number">100</span>, <span class="hljs-string">&#x27;2023-08-09 00:00:00&#x27;</span>, <span class="hljs-number">1</span>);<br><span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> collapsing_table <span class="hljs-keyword">values</span> (<span class="hljs-string">&#x27;A002&#x27;</span>, <span class="hljs-number">100</span>, <span class="hljs-string">&#x27;2023-08-09 00:00:00&#x27;</span>, <span class="hljs-number">1</span>);<br></code></pre></td></tr></table></figure>

<p>ä¿®æ”¹ A000 çš„ Code ä¸º 200 å¹¶åˆ é™¤ A002 çš„æ•°æ®</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs sql"># ä¿®æ”¹ A000 çš„ Code ä¸º <span class="hljs-number">200</span><br><span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> collapsing_table <span class="hljs-keyword">values</span> (<span class="hljs-string">&#x27;A000&#x27;</span>, <span class="hljs-number">100</span>, <span class="hljs-string">&#x27;2023-08-09 00:00:00&#x27;</span>, <span class="hljs-number">-1</span>);<br><span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> collapsing_table <span class="hljs-keyword">values</span> (<span class="hljs-string">&#x27;A000&#x27;</span>, <span class="hljs-number">200</span>, <span class="hljs-string">&#x27;2023-08-09 00:00:00&#x27;</span>, <span class="hljs-number">1</span>);<br># åˆ é™¤ A002 çš„æ•°æ®<br><span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> collapsing_table <span class="hljs-keyword">values</span> (<span class="hljs-string">&#x27;A002&#x27;</span>, <span class="hljs-number">100</span>, <span class="hljs-string">&#x27;2023-08-09 00:00:00&#x27;</span>, <span class="hljs-number">-1</span>);<br># æ‰‹åŠ¨æ‰§è¡Œä¸€ä¸‹åˆ†åŒºåˆå¹¶æ“ä½œ<br>optimize <span class="hljs-keyword">table</span> collapsing_table <span class="hljs-keyword">final</span>;<br></code></pre></td></tr></table></figure>

<p>å¯ä»¥è§‚å¯Ÿåˆ°æ•°æ®å·²ç»è¢«åˆ é™¤å’Œä¿®æ”¹ã€‚</p>
<p>CollapsingMergeTree åœ¨åˆ†åŒºåˆå¹¶æŠ˜å æ•°æ®çš„æ—¶å€™ï¼Œéµå¾ªä¸‹é¢è§„åˆ™</p>
<ol>
<li>å¦‚æœ sign &#x3D; 1 æ¯” sign &#x3D; -1 å¤šä¸€è¡Œï¼Œæœ€åä¿ç•™ sign &#x3D; 1 çš„æ•°æ®</li>
<li>å¦‚æœ sign &#x3D; 1 æ¯” sign &#x3D; -1 å°‘ä¸€è¡Œï¼Œæœ€åä¿ç•™ sign &#x3D; -1 çš„æ•°æ®</li>
<li>å¦‚æœ sign &#x3D; 1 å’Œ sign &#x3D; -1 ä¸€æ ·å¤šï¼Œä¸”æœ€åä¸€è¡Œæ—¶ sign &#x3D; 1ï¼Œåˆ™ä¿ç•™ç¬¬ä¸€è¡Œçš„ sign &#x3D; -1 å’Œæœ€åä¸€è¡Œ sign &#x3D; 1</li>
<li>å¦‚æœ sign &#x3D; 1 å’Œ sign &#x3D; -1 ä¸€æ ·å¤šï¼Œä¸”æœ€åä¸€è¡Œæ—¶ sign &#x3D; -1ï¼Œåˆ™ä»€ä¹ˆä¹Ÿä¸ä¿ç•™</li>
<li>å…¶ä½™æƒ…å†µ clickhouse ä¼šæ‰“å°å‘Šè­¦æ—¥å¿—ï¼Œä½†ä¸ä¼šæŠ¥é”™ä¸”æŸ¥è¯¢æƒ…å†µä¸å¯é¢„çŸ¥</li>
</ol>
<h2 id="2-2-ä¸è¶³"><a href="#2-2-ä¸è¶³" class="headerlink" title="2.2 ä¸è¶³"></a>2.2 ä¸è¶³</h2><p>å½“å‰è¡¨çš„æ•°æ®å¦‚ä¸‹</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span><br><span class="hljs-keyword">from</span> collapsing_table;<br><br>Query id: <span class="hljs-number">4</span>b1da757<span class="hljs-operator">-</span>d02a<span class="hljs-number">-4</span>b88<span class="hljs-number">-92e5</span><span class="hljs-number">-1</span>fe659ca462c<br><br>â”Œâ”€Idâ”€â”€â”€â”¬â”€Codeâ”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€CreateTimeâ”€â”¬â”€Signâ”€â”<br>â”‚ A002 â”‚  <span class="hljs-number">300</span> â”‚ <span class="hljs-number">2023</span><span class="hljs-number">-08</span><span class="hljs-number">-09</span> <span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span> â”‚   <span class="hljs-number">-1</span> â”‚<br>â””â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”˜<br>â”Œâ”€Idâ”€â”€â”€â”¬â”€Codeâ”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€CreateTimeâ”€â”¬â”€Signâ”€â”<br>â”‚ A002 â”‚  <span class="hljs-number">300</span> â”‚ <span class="hljs-number">2023</span><span class="hljs-number">-08</span><span class="hljs-number">-09</span> <span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span> â”‚    <span class="hljs-number">1</span> â”‚<br>â””â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”˜<br>â”Œâ”€Idâ”€â”€â”€â”¬â”€Codeâ”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€CreateTimeâ”€â”¬â”€Signâ”€â”<br>â”‚ A000 â”‚  <span class="hljs-number">200</span> â”‚ <span class="hljs-number">2023</span><span class="hljs-number">-08</span><span class="hljs-number">-09</span> <span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span> â”‚    <span class="hljs-number">1</span> â”‚<br>â”‚ A001 â”‚  <span class="hljs-number">100</span> â”‚ <span class="hljs-number">2023</span><span class="hljs-number">-08</span><span class="hljs-number">-09</span> <span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span> â”‚    <span class="hljs-number">1</span> â”‚<br>â””â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”˜<br><br><span class="hljs-number">4</span> <span class="hljs-keyword">rows</span> <span class="hljs-keyword">in</span> set. Elapsed: <span class="hljs-number">0.003</span> sec.<br></code></pre></td></tr></table></figure>

<p>ä»æ“ä½œæ¥çœ‹ A002 æ˜¯è¦è¢«åˆ é™¤çš„</p>
<p>ä½†æ˜¯å¦‚æœæŸ¥è¯¢sqlå¦‚ä¸‹</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> Id, <span class="hljs-built_in">sum</span>(Code), <span class="hljs-built_in">count</span>(Code), <span class="hljs-built_in">avg</span>(Code)<br><span class="hljs-keyword">from</span> collapsing_table<br><span class="hljs-keyword">group</span> <span class="hljs-keyword">by</span> Id;<br><br>Query id: <span class="hljs-number">610</span>f6503<span class="hljs-number">-1344</span><span class="hljs-number">-4</span>ba0<span class="hljs-number">-9564</span><span class="hljs-number">-6327277</span>ffe95<br><br>â”Œâ”€Idâ”€â”€â”€â”¬â”€<span class="hljs-built_in">sum</span>(Code)â”€â”¬â”€<span class="hljs-built_in">count</span>(Code)â”€â”¬â”€<span class="hljs-built_in">avg</span>(Code)â”€â”<br>â”‚ A001 â”‚       <span class="hljs-number">100</span> â”‚           <span class="hljs-number">1</span> â”‚       <span class="hljs-number">100</span> â”‚<br>â”‚ A000 â”‚       <span class="hljs-number">200</span> â”‚           <span class="hljs-number">1</span> â”‚       <span class="hljs-number">200</span> â”‚<br>â”‚ A002 â”‚       <span class="hljs-number">600</span> â”‚           <span class="hljs-number">2</span> â”‚       <span class="hljs-number">300</span> â”‚<br>â””â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜<br><br><span class="hljs-number">3</span> <span class="hljs-keyword">rows</span> <span class="hljs-keyword">in</span> set. Elapsed: <span class="hljs-number">0.005</span> sec.<br></code></pre></td></tr></table></figure>

<p>æ­¤æ—¶çš„ç»“æœæ˜¯ä¸å¯¹çš„ï¼Œå› æ­¤éœ€è¦æ”¹å†™ sql</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> Id, <span class="hljs-built_in">sum</span>(Code <span class="hljs-operator">*</span> Sign), <span class="hljs-built_in">count</span>(Code <span class="hljs-operator">*</span> Sign), <span class="hljs-built_in">avg</span>(Code <span class="hljs-operator">*</span> Sign)<br><span class="hljs-keyword">from</span> collapsing_table<br><span class="hljs-keyword">group</span> <span class="hljs-keyword">by</span> Id<br><span class="hljs-keyword">having</span> <span class="hljs-built_in">sum</span>(Sign) <span class="hljs-operator">&gt;</span> <span class="hljs-number">0</span>;<br><br>Query id: a3fe84d0<span class="hljs-number">-33</span>a5<span class="hljs-number">-4287</span><span class="hljs-operator">-</span>bd02<span class="hljs-number">-49</span>ab03df1852<br><br>â”Œâ”€Idâ”€â”€â”€â”¬â”€<span class="hljs-built_in">sum</span>(multiply(Code, Sign))â”€â”¬â”€<span class="hljs-built_in">count</span>(multiply(Code, Sign))â”€â”¬â”€<span class="hljs-built_in">avg</span>(multiply(Code, Sign))â”€â”<br>â”‚ A001 â”‚                       <span class="hljs-number">100</span> â”‚                           <span class="hljs-number">1</span> â”‚                       <span class="hljs-number">100</span> â”‚<br>â”‚ A000 â”‚                       <span class="hljs-number">200</span> â”‚                           <span class="hljs-number">1</span> â”‚                       <span class="hljs-number">200</span> â”‚<br>â””â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜<br><br><span class="hljs-number">2</span> <span class="hljs-keyword">rows</span> <span class="hljs-keyword">in</span> set. Elapsed: <span class="hljs-number">0.005</span> sec.<br></code></pre></td></tr></table></figure>

<p>å½“ç„¶è¿˜æœ‰ä¸€ç§æ–¹å¼å°±æ˜¯åœ¨æŸ¥è¯¢æ•°æ®å‰æ‰§è¡Œåˆ†åŒºåˆå¹¶æ“ä½œ<code>optimize table collapsing_table final;</code>ï¼Œä½†è¿™ç§æ–¹å¼æ•ˆç‡æä½åœ¨ç”Ÿäº§ä¸­æ…ç”¨</p>
<p>åŒæ—¶ CollapsingMergeTree è¿˜å­˜åœ¨ä¸€äº›é—®é¢˜ï¼Œä¾‹å¦‚åœ¨åˆ†åŒºåˆå¹¶å‰ç”¨æˆ·æ˜¯å¯ä»¥çœ‹åˆ°æ‰€æœ‰æ•°æ®çš„ã€‚å½“ç„¶ä¸Šé¢æ‰€è¯´çš„é—®é¢˜éƒ½ä¸æ˜¯æœ€è‡´å‘½çš„ï¼ŒCollapsingMergeTree æœ€è‡´å‘½ç‚¹åœ¨äºå¯¹äº sign çš„å†™å…¥é¡ºåºæœ‰ä¸¥æ ¼çš„è¦æ±‚ï¼Œå¯¹äºä¸€ä¸ªåˆ é™¤æ“ä½œæ­£å¸¸çš„é¡ºåºåº”è¯¥æ˜¯å…ˆå†™å…¥ 1 å†å†™å…¥ -1</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> collapsing_table <span class="hljs-keyword">values</span> (<span class="hljs-string">&#x27;A002&#x27;</span>, <span class="hljs-number">300</span>, <span class="hljs-string">&#x27;2023-08-09 00:00:00&#x27;</span>, <span class="hljs-number">1</span>);<br><span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> collapsing_table <span class="hljs-keyword">values</span> (<span class="hljs-string">&#x27;A002&#x27;</span>, <span class="hljs-number">300</span>, <span class="hljs-string">&#x27;2023-08-09 00:00:00&#x27;</span>, <span class="hljs-number">-1</span>);<br></code></pre></td></tr></table></figure>

<p>ä½†å¦‚æœé¢ å€’é¡ºåº</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> collapsing_table <span class="hljs-keyword">values</span> (<span class="hljs-string">&#x27;A002&#x27;</span>, <span class="hljs-number">300</span>, <span class="hljs-string">&#x27;2023-08-09 00:00:00&#x27;</span>, <span class="hljs-number">-1</span>);<br><span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> collapsing_table <span class="hljs-keyword">values</span> (<span class="hljs-string">&#x27;A002&#x27;</span>, <span class="hljs-number">300</span>, <span class="hljs-string">&#x27;2023-08-09 00:00:00&#x27;</span>, <span class="hljs-number">1</span>);<br></code></pre></td></tr></table></figure>

<p>åˆ™ä¸ä¼šè¢«åˆ é™¤ã€‚è€Œåœ¨ç”Ÿäº§ç¯å¢ƒä¸€æ—¦ CollapsingMergeTree åœ¨å¤šçº¿ç¨‹ä¸­å¤„ç†å°±æ— æ³•ä¿è¯å†™å…¥é¡ºåºäº†ã€‚</p>
<p>å½“ç„¶å¹¸è¿çš„æ˜¯ clickhouse ä¹Ÿæ³¨æ„åˆ° CollapsingMergeTree çš„ç¼ºç‚¹å¹¶æ¨å‡ºäº†æ–°çš„è¡¨å¼•æ“ VersionedCollapsingMergeTreeï¼Œåœ¨ CollapsingMergeTree çš„åŸºç¡€ä¸Šå°†æŒ‰ç…§å†™å…¥é¡ºåºæŠ˜å ä¿®æ”¹ä¸ºæŒ‰ç…§ç‰ˆæœ¬å·é¡ºåºè¿›è¡ŒæŠ˜å ï¼Œè€Œç‰ˆæœ¬å·äº¤ç”±ç”¨æˆ·æ¥ç®¡ç†ã€‚VersionedCollapsingMergeTree å¼•æ“çš„æ“ä½œå°±äº¤ç»™è¯»è€…æ¥ä½“éªŒï¼Œæ¯•ç«Ÿä¸‹é¢è¿˜æœ‰ä¸€ç§æ›´è´´åˆ TP æ•°æ®åº“æ“ä½œçš„åˆ é™¤æ“ä½œ</p>
<h1 id="ä¸‰ã€lightweight"><a href="#ä¸‰ã€lightweight" class="headerlink" title="ä¸‰ã€lightweight"></a>ä¸‰ã€lightweight</h1><p>ä¸Šé¢ä»‹ç»äº†é€šè¿‡ mutation å’Œ mergeTree æ¥å®ç°åˆ é™¤æ“ä½œï¼Œä½†æ˜¯ mutation æ“ä½œå¤ªé‡ï¼ŒmergeTree åˆ™éœ€è¦ä¿®æ”¹ sql ä¸”åˆ é™¤æ“ä½œå—åˆ†åŒºåˆå¹¶æ—¶æœºå½±å“ã€‚ä» clickhouse v22.8 å¼€å§‹æä¾›äº†ä¸€ä¸ªè½»é‡çº§åˆ é™¤åŠŸèƒ½ä¸”è¯­æ³•ä¸ºæ ‡å‡† sql ğŸ‰ğŸ‰ğŸ‰</p>
<h2 id="3-1-å®æ“"><a href="#3-1-å®æ“" class="headerlink" title="3.1 å®æ“"></a>3.1 å®æ“</h2><p>å‡†å¤‡è¡¨å’Œæ•°æ®</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> lightweight_operate<br>(<br>    UserId     UInt64,<br>    Score      UInt64,<br>    CreateTime DateTime<br>) engine <span class="hljs-operator">=</span> MergeTree()<br>      <span class="hljs-keyword">partition</span> <span class="hljs-keyword">by</span> toYYYYMMDD(CreateTime)<br>      <span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> UserId;<br><br><span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> lightweight_operate<br><span class="hljs-keyword">select</span> number,<br>       <span class="hljs-built_in">abs</span>(number <span class="hljs-operator">-</span> <span class="hljs-number">100</span>),<br>       <span class="hljs-string">&#x27;2023-08-08 00:00:00&#x27;</span><br><span class="hljs-keyword">from</span> system.numbers<br>limit <span class="hljs-number">1000000</span>;<br><br><span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> lightweight_operate<br><span class="hljs-keyword">select</span> number,<br>       <span class="hljs-built_in">abs</span>(number <span class="hljs-operator">-</span> <span class="hljs-number">100</span>),<br>       <span class="hljs-string">&#x27;2023-08-09 00:00:00&#x27;</span><br><span class="hljs-keyword">from</span> system.numbers<br>limit <span class="hljs-number">1000000</span>;<br></code></pre></td></tr></table></figure>

<p>åŒæ ·åˆ é™¤ 20230808 åˆ†åŒºä¸­ 1000-10000 ä¹‹é—´çš„æ‰€æœ‰æ•°æ®ï¼Œsql å¦‚ä¸‹</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">delete</span> <span class="hljs-keyword">from</span> lightweight_operate <span class="hljs-keyword">where</span> toYYYYMMDD(CreateTime) <span class="hljs-operator">=</span> <span class="hljs-number">20230808</span> <span class="hljs-keyword">and</span> UserId <span class="hljs-keyword">between</span> <span class="hljs-number">1000</span> <span class="hljs-keyword">and</span> <span class="hljs-number">10000</span>;<br></code></pre></td></tr></table></figure>

<p>éªŒè¯ä¸€ä¸‹</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> <span class="hljs-built_in">count</span>() <span class="hljs-keyword">from</span> lightweight_operate <span class="hljs-keyword">where</span> toYYYYMMDD(CreateTime) <span class="hljs-operator">=</span> <span class="hljs-number">20230808</span>;<br><br>Query id: <span class="hljs-number">0344</span>da3b<span class="hljs-number">-5</span>ea5<span class="hljs-number">-436</span>d<span class="hljs-operator">-</span>ba29<span class="hljs-operator">-</span>cfb1a8e3420e<br><br>â”Œâ”€<span class="hljs-built_in">count</span>()â”€â”<br>â”‚  <span class="hljs-number">990999</span> â”‚<br>â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜<br><br><span class="hljs-number">1</span> <span class="hljs-type">row</span> <span class="hljs-keyword">in</span> set. Elapsed: <span class="hljs-number">0.008</span> sec. Processed <span class="hljs-number">1.00</span> million <span class="hljs-keyword">rows</span>, <span class="hljs-number">5.00</span> MB (<span class="hljs-number">128.59</span> million <span class="hljs-keyword">rows</span><span class="hljs-operator">/</span>s., <span class="hljs-number">642.93</span> MB<span class="hljs-operator">/</span>s.)<br></code></pre></td></tr></table></figure>

<p>æˆåŠŸåˆ é™¤</p>
<h2 id="3-2-åŸç†"><a href="#3-2-åŸç†" class="headerlink" title="3.2 åŸç†"></a>3.2 åŸç†</h2><p>æŸ¥çœ‹ç£ç›˜ç›®å½•</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs shell">Â» ll<br>total 16<br>drwxr-x---@ 16 wjun  admin  512 Aug  9 21:09 20230808_1_1_0<br>drwxr-x---@ 18 wjun  admin  576 Aug  9 21:10 20230808_1_1_0_3<br>drwxr-x---@ 16 wjun  admin  512 Aug  9 21:09 20230809_2_2_0<br>drwxr-x---@ 15 wjun  admin  480 Aug  9 21:10 20230809_2_2_0_3<br>drwxr-x---@  2 wjun  admin   64 Aug  9 21:09 detached<br>-rw-r-----@  1 wjun  admin    1 Aug  9 21:09 format_version.txt<br>-rw-r-----@  1 wjun  admin  171 Aug  9 21:10 mutation_3.txt<br><br>Â» du -h<br>  0B	./detached<br>7.7M	./20230809_2_2_0<br>7.7M	./20230808_1_1_0<br>  0B	./20230809_2_2_0_3<br> 28K	./20230808_1_1_0_3<br> 15M	.<br></code></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹å‡ºè½»é‡åˆ é™¤ä¾ç„¶æ˜¯ä¸€ä¸ª mutation æ“ä½œï¼Œä»<code>system.mutations</code>è¡¨ä¹Ÿå¯ä»¥éªŒè¯ï¼Œä½†è½»é‡åˆ é™¤ç”Ÿæˆçš„æ–°çš„åˆ†åŒº 20230808_1_1_0_3 ä»… 28Kï¼Œé‚£ä¹ˆè½»é‡åˆ é™¤å’Œ mutation åˆ é™¤çš„åŒºåˆ«åœ¨å“ª</p>
<p>æŸ¥çœ‹ 20230808_1_1_0_3 ç£ç›˜ç›®å½•</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs shell">wjun :: data/delete_operate/lightweight_operate â€¹stableâ€º Â» ll 20230808_1_1_0_3<br>total 15800<br>-rw-r-----@ 2 wjun  admin    18042 Aug  9 21:09 CreateTime.bin<br>-rw-r-----@ 2 wjun  admin      375 Aug  9 21:09 CreateTime.cmrk2<br>-rw-r-----@ 2 wjun  admin  4004938 Aug  9 21:09 Score.bin<br>-rw-r-----@ 2 wjun  admin      415 Aug  9 21:09 Score.cmrk2<br>-rw-r-----@ 2 wjun  admin  4004915 Aug  9 21:09 UserId.bin<br>-rw-r-----@ 2 wjun  admin      415 Aug  9 21:09 UserId.cmrk2<br>-rw-r-----@ 1 wjun  admin     4493 Aug  9 21:10 _row_exists.bin<br>-rw-r-----@ 1 wjun  admin      236 Aug  9 21:10 _row_exists.cmrk2<br>-rw-r-----@ 1 wjun  admin      589 Aug  9 21:10 checksums.txt<br>-rw-r-----@ 1 wjun  admin      110 Aug  9 21:10 columns.txt<br>-rw-r-----@ 2 wjun  admin        7 Aug  9 21:09 count.txt<br>-rw-r-----@ 1 wjun  admin       10 Aug  9 21:10 default_compression_codec.txt<br>-rw-r-----@ 1 wjun  admin        1 Aug  9 21:10 metadata_version.txt<br>-rw-r-----@ 2 wjun  admin        8 Aug  9 21:09 minmax_CreateTime.idx<br>-rw-r-----@ 2 wjun  admin        4 Aug  9 21:09 partition.dat<br>-rw-r-----@ 2 wjun  admin      173 Aug  9 21:09 primary.cidx<br></code></pre></td></tr></table></figure>

<p>å‘ç°å¤šäº†ä¸€ç»„ _row_exists æ–‡ä»¶è€Œå…¶ä½™æ–‡ä»¶çš„ inode è¿æ¥æ•°å‡ä¸º 2ï¼Œä¹Ÿå°±æ˜¯è¯´è½»é‡åˆ é™¤æ˜¯çœŸæ­£çš„ç»™å­—æ®µæ·»åŠ äº†ä¸€ä¸ªæ ‡è®°ã€‚</p>
<p>åœ¨æŸ¥è¯¢çš„æ—¶å€™è¿‡æ»¤</p>
<img src="https://cdn.jsdelivr.net/gh/kpretty/oss@master/2023-08-09/lightweight_deletes_v2_b891b54446.png" alt="lightweight_deletes_v2_b891b54446" style="zoom:80%;" />

<p>åœ¨åˆ†åŒºåˆå¹¶çš„æ—¶å€™åˆ é™¤</p>
<img src="https://cdn.jsdelivr.net/gh/kpretty/oss@master/2023-08-09/lightweight_delete_merge_1_a2519ab507.png" alt="lightweight_delete_merge_1_a2519ab507" style="zoom:70%;" />

<p>æ¯” mutation è½»çš„ç‚¹åœ¨äºè½»é‡åˆ é™¤ä¸ä¼šé‡æ„æ•´ä¸ªåˆ†åŒºç›®å½•è€Œæ˜¯é‡å†™ _row_exists æ–‡ä»¶è¿™æ ·æ¶‰åŠåˆ°çš„ä¿®æ”¹ä¼šå°‘å¾ˆå¤šï¼Œè‡³äºåˆ†åŒºçš„æ‹·è´å’Œä¸æ¶‰åŠåˆ é™¤æ“ä½œçš„åˆ†åŒºæ“ä½œé€»è¾‘åˆ™å’Œä¸Šé¢ä»‹ç»çš„ mutation æµç¨‹ä¸€è‡´</p>
<h2 id="3-3-ä¸è¶³"><a href="#3-3-ä¸è¶³" class="headerlink" title="3.3 ä¸è¶³"></a>3.3 ä¸è¶³</h2><p>è½»é‡åˆ é™¤çš„è®¾è®¡æ€è·¯ç›¸æ¯”ä¹‹å‰çš„ä¼šå¥½ä¸Šå¾ˆå¤šï¼Œä½† clickhouse æ¯•ç«Ÿä¸æ˜¯ TP æ•°æ®åº“ï¼Œç›®å‰è½»é‡åˆ é™¤ä¾ç„¶å­˜åœ¨ä¸€äº›é—®é¢˜å’Œé™åˆ¶ï¼Œå¦‚ï¼š</p>
<ol>
<li>è½»é‡åˆ é™¤æ˜¯å¼‚æ­¥çš„ï¼Œåªæœ‰åœ¨åˆ†åŒºåˆå¹¶çš„æ—¶å€™æ‰ä¼šè¢«çœŸæ­£åˆ é™¤ï¼ˆè½»é‡åˆ é™¤æ‰§è¡Œå®Œæ˜¯é€»è¾‘ä¸Šåˆ é™¤ï¼‰</li>
<li>å¯¹ wide ç±»å‹åˆ†åŒºå‹å¥½ï¼Œå¯¹äº compact ç±»å‹åˆ†åŒºä¼šäº§ç”Ÿè¾ƒå¤§çš„ç£ç›˜ IO</li>
<li>ä¼šä¿®æ”¹åˆ†åŒºåœ¨ç£ç›˜ä¸­çš„åç§°ï¼Œå¯èƒ½ä¼šå½±å“å¤‡ä»½</li>
</ol>
<p>å¯¹äº mutation æ˜¯å¦ä¸ºå¼‚æ­¥æ“ä½œå¯ä»¥é€šè¿‡å‚æ•°è¿›è¡Œé…ç½®ï¼Œåªéœ€å°†<code>mutations_sync</code>ç½®ä¸º true å³å¯</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">set</span> mutations_sync <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>;<br></code></pre></td></tr></table></figure>

<p>è‡³äºå…¶å®ƒçš„ä¸è¶³éœ€è¦ç”¨æˆ·ç»“åˆå®é™…åœºæ™¯è¿›è¡Œå–èˆ</p>

      </div>
    </div>
  </article>
  <div class="post__foot">
    
      <div class="like-author">
  <input type="checkbox" id="likeCode" />
  <div class="author-face">
    <img height="100px"
         width="100px"
         id="front-face"
         alt="author face"
         src="https://cdn.jsdelivr.net/gh/kpretty/oss@master/2023-10-31/IMG_4075.JPG" />
    <img height="100px"
         width="100px"
         id="back-face"
         alt="like code"
         src="https://cdn.jsdelivr.net/gh/kpretty/oss@master/2023-08-10/QRcode_A%20%E2%80%94%20a1.jpg" />
  </div>
  <div class="like-text">è¯·ä½œè€…å–æ¯å’–å•¡</div>
  <label for="likeCode" class="like-btn">
    <svg viewBox="0 0 1024 1024"
         width="20px"
         style="margin-right: 10px"
         height="20px">
      <path d="M466.88 908.96L113.824 563.296a270.08 270.08 0 0 1 0-387.392c108.8-106.56 284.896-106.56 393.696 0 1.504 1.472 2.976 2.944 4.448 4.48 1.472-1.536 2.944-3.008 4.448-4.48 108.8-106.56 284.896-106.56 393.696 0a269.952 269.952 0 0 1 34.016 347.072l-387.392 385.6a64 64 0 0 1-89.92 0.384z" p-id="13650" fill="#ee4242" />
    </svg>
    å–œæ¬¢ä½œè€…
  </label>
</div>

    
    <div class="post-nav">
  
    <a class="post-nav-item-left" href="/2023/09/14/hive/mapjoin-problem/">
      <div class="text-align">
        <svg t="1670570876164"
             class="icon"
             viewBox="0 0 1024 1024"
             width="16"
             height="16">
          <path d="M384 512L731.733333 202.666667c17.066667-14.933333 19.2-42.666667 4.266667-59.733334-14.933333-17.066667-42.666667-19.2-59.733333-4.266666l-384 341.333333c-10.666667 8.533333-14.933333 19.2-14.933334 32s4.266667 23.466667 14.933334 32l384 341.333333c8.533333 6.4 19.2 10.666667 27.733333 10.666667 12.8 0 23.466667-4.266667 32-14.933333 14.933333-17.066667 14.933333-44.8-4.266667-59.733334L384 512z" p-id="14596"/>
        </svg>
        <span class="text-small">ä¸Šä¸€ç¯‡</span>
      </div>
      <div>hive çš„ mapjoin ä¸€å®šæ˜¯ä¼˜åŒ–æ‰‹æ®µå—</div>
    </a>
  
  <div class="vhr"></div>
  
    <a class="post-nav-item-right" href="/2023/08/01/clickhouse/query-cache/">
      <div class="text-align">
        <span class="text-small">ä¸‹ä¸€ç¯‡</span>
        <svg t="1670570876164"
             class="icon"
             viewBox="0 0 1024 1024"
             transform="scale(-1,-1)"
             width="16"
             height="16">
          <path d="M384 512L731.733333 202.666667c17.066667-14.933333 19.2-42.666667 4.266667-59.733334-14.933333-17.066667-42.666667-19.2-59.733333-4.266666l-384 341.333333c-10.666667 8.533333-14.933333 19.2-14.933334 32s4.266667 23.466667 14.933334 32l384 341.333333c8.533333 6.4 19.2 10.666667 27.733333 10.666667 12.8 0 23.466667-4.266667 32-14.933333 14.933333-17.066667 14.933333-44.8-4.266667-59.733334L384 512z" p-id="14596"/>
        </svg>
      </div>
      clickhouse æŸ¥è¯¢ç¼“å­˜
    </a>
  
</div>

    
      <div class="related-post">
  <div class="related__head">
  <a href="/tags/clickhouse/" class="post-tag">#clickhouse</a>

</div>
  <div class="realated__body">
    
      <div class="null"><div class="null-item"><div class="null-title"><a href="/2023/08/01/clickhouse/query-cache/" title="clickhouse æŸ¥è¯¢ç¼“å­˜" rel="bookmark">clickhouse æŸ¥è¯¢ç¼“å­˜</a></div></div><div class="null-item"><div class="null-title"><a href="/2023/07/27/clickhouse/sql-downgrade/" title="clickhouse åˆ†å¸ƒå¼æŸ¥è¯¢é™çº§ä¸ºæœ¬åœ°æŸ¥è¯¢" rel="bookmark">clickhouse åˆ†å¸ƒå¼æŸ¥è¯¢é™çº§ä¸ºæœ¬åœ°æŸ¥è¯¢</a></div></div></div>
    
  </div>
</div>

    
    <div id="gitalk-container"></div>
  </div>

    </div>
    <div class="foot">
      <div class="foot-inner">
        <div class="foot__head">
          
            <div class="foot-line">
              <div class="matts">æ¢</div><div class="matts">ç´¢</div><div class="matts">æœª</div><div class="matts">çŸ¥</div><div class="matts">æ¿€</div><div class="matts">å‘</div><div class="matts">çµ</div><div class="matts">æ„Ÿ</div>
            </div>
          
            <div class="foot-line">
              <div class="matts">è‡ª</div><div class="matts">ç”±</div><div class="matts">åˆ›</div><div class="matts">é€ </div><div class="matts">è·¨</div><div class="matts">è¶Š</div><div class="matts">ç•Œ</div><div class="matts">é™</div>
            </div>
          
        </div>
        <div class="foot__body">
          
            <div class="foot-item">
              <div class="foot-item__head">æœ‹å‹</div>
              <div class="foot-item__body">
                
                  <div class="text">
                    <img alt="link" height="20px" width="20px" src="/images/icon/icon-link.svg" />
                    <a class="foot-link" target="_blank" rel="noopener" href="https://kpretty.tech">åšä¸»çš„ä¸»ç«™</a>
                  </div>
                
                <div class="text">
                  <img alt="link" height="20px" width="20px" src="/images/icon/icon-link+.svg" />
                  <a class="foot-link"
                     href="mailto:wjunjobs@outlook.com?subject=%E7%94%B3%E8%AF%B7%20Hozen.site%20%E7%9A%84%E5%8F%8B%E9%93%BE%E4%BD%8D%E7%BD%AE">
                  ç”³è¯·å‹é“¾</a>
                </div>
              </div>
            </div>
          
          
            <div class="foot-item">
              <div class="foot-item__head">è´¦å·</div>
              <div class="foot-item__body">
                
                  <div class="text">
                    <img alt="link" height="20px" width="20px" src="/images/logo-github.svg" />
                    <a class="foot-link" target="_blank" rel="noopener" href="https://github.com/kpretty">github</a>
                  </div>
                
              </div>
            </div>
          
          <div class="foot-item">
            <div class="foot-item__head">è”ç³»</div>
            <div class="foot-item__body">
              <div class="text">
                <img alt="link" height="20px" width="20px" src="/images/icon/icon-email.svg" />
                <a class="foot-link" href="mailto:wjunjobs@outlook.com">wjunjobs@outlook.com</a>
              </div>
            </div>
          </div>
        </div>
        <div class="copyright">
          <a href="https://uhope.fun">Youth Hope Fun</a> &nbsp;|&nbsp;ç”±&nbsp;<a target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a>&nbsp;åŠ&nbsp;
          <svg width="20" height="20" viewBox="0 0 725 725">
            <path fill-rule="evenodd" fill="rgb(221, 221, 221)" d="M145.870,236.632 L396.955,103.578 L431.292,419.44 L156.600,522.53 L145.870,236.632 Z" />
            <path fill-rule="evenodd" fill="rgb(159, 159, 159)" d="M396.955,103.578 L564.345,234.486 L611.558,513.469 L431.292,419.44 L396.955,103.578 Z" />
            <path fill-rule="evenodd" fill="rgb(0, 0, 0)" d="M431.292,419.44 L611.558,513.469 L358.327,595.18 L156.600,522.53 L431.292,419.44 Z" />
          </svg>
          <a target="_blank" rel="noopener" href="https://github.com/hooozen/hexo-theme-tranquility">è‡´è¿œ</a>&nbsp;é©±åŠ¨
        </div>
      </div>
    </div>
    
      <script src="https://unpkg.com/js-polyfills@0.1.43/es6.js"></script>
      <script id="MathJax-script"
              async
              src="https://www.unpkg.com/mathjax@3.2.2/es5/tex-mml-chtml.js"></script>
    
    
  <script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>
<script type="text/javascript">
  const param = JSON.parse('{"enable":true,"owner":"kpretty","admin":["kpretty"],"repo":"blog-comment","clientID":"0ca314933bd70869d267","clientSecret":"1d9a7930f641b37c9900ae8105fab1275c4d84ba","distractionFreeMode":false,"proxy":"https://cors-anywhere.azm.workers.dev/https://github.com/login/oauth/access_token","language":"zh-CN"}')
  param.id = location.pathname
  const gitalk = new Gitalk(param)
  gitalk.render('gitalk-container')
</script>


  </body>
</html>
